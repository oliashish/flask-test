name: Github action for your deployment

on:
    push:
      branches: [main]

jobs:
    build:

        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v3
        - name: Set up Python 3
          uses: actions/setup-python@v3
          with:
            python-version: 3
        - name: Install Dependencies
          run: |
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then
                pip install -r requirements.txt
            else 
                pip freeze > requirements.txt
            fi

        - name: Creting a Dockerfile
          run: | 
            echo
              "
              FROM python3
              WORKDIR /app
              RUN pip3 install -r requirements.txt
              COPY . .
              RUN cd src/
              CMD ["python3", "app.py"]
              " > Dockerfile

        - name: Docker login
          uses: docker/login-action@v1 
          with:
            registry: registry.patr.cloud
            username: ${{secrets.username}}
            password: ${{ secrets.REGISTRY_PASSWORD }}

        - name: Build image from Dockerfile and push to patr-registry
          run: |
            docker build . -t ${{secrets.username}}/deployment
            docker tag ${{secrets.username}}/deployment registry.patr.cloud/personal-workspace-1424404d9fff474bba7f23825681f6a8/flask:latest 
            docker push registry.patr.cloud/personal-workspace-1424404d9fff474bba7f23825681f6a8/flask:latest
